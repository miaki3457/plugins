name: Auto Generate Repo from Zip
on:
  push:
    branches: [ main ]
    paths:
      - 'plugins/**.zip'

jobs:
  generate-repo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract Metadata and Build repo.json
        run: |
          echo "[]" > repo.json
          BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

          for zipfile in plugins/*.zip; do
            [ -e "$zipfile" ] || continue
            filename=$(basename "$zipfile" .zip)
            unzip -p "$zipfile" "*.json" | jq -c 'select(.InternalName != null)' > temp_meta.json
            if [ ! -s temp_meta.json ]; then continue; fi

            DOWNLOAD_URL="${BASE_URL}/plugins/${filename}.zip"
            jq --arg url "$DOWNLOAD_URL" '. + {DownloadLinkInstall: $url}' temp_meta.json > single_plugin.json
            jq -s '.[0] + .[1]' repo.json "[$(cat single_plugin.json)]" > new_repo.json
            mv new_repo.json repo.json
          done

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages # 這是關鍵，成品會放在這