name: Auto Correct and Generate Repo
on:
  push:
    branches: [ zips ]  # 只有當你上傳東西到 zips 分支時才執行
  workflow_dispatch:

jobs:
  generate-repo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout zips branch (Source)
        uses: actions/checkout@v3
        with:
          ref: zips  # 抓取 zips 分支的檔案

      - name: Process Zips and Build repo.json
        run: |
          ROOT_DIR=$(pwd)
          OUT_DIR="$ROOT_DIR/output"
          PLUGINS_OUT="$OUT_DIR/plugins"
          
          mkdir -p "$PLUGINS_OUT"
          echo "[]" > "$OUT_DIR/repo.json"
          
          # 生成 index.md (使用 cat <<EOF 確保格式絕對正確)
          cat <<EOF > "$OUT_DIR/index.md"
          ---
          
          # 插件列表
          > **最後更新時間：** $(date +'%Y-%m-%d %H:%M:%S')
          
          將此網址複製到 Dalamud 的 Plugin Repos: 
          \`https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/repo.json\`
          
          | 名稱 | 版本 | 描述 |
          | :--- | :--- | :--- |
          EOF
          
          BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

          for zipfile in plugins/*.zip; do
            [ -e "$zipfile" ] || continue
            filename=$(basename "$zipfile")
            
            TMP_WORK="$ROOT_DIR/temp_$(date +%s)"
            mkdir -p "$TMP_WORK"
            unzip -q "$zipfile" -d "$TMP_WORK" || true
            
            manifest_path=$(find "$TMP_WORK" -name "*.json" -exec grep -l "InternalName" {} + | head -n 1)
            if [ -z "$manifest_path" ]; then rm -rf "$TMP_WORK"; continue; fi

            plugin_dir=$(dirname "$manifest_path")
            cd "$plugin_dir"
            zip -r "$PLUGINS_OUT/$filename" ./*
            cd "$ROOT_DIR"
            
            # 生成 JSON
            jq -c --arg url "${BASE_URL}/plugins/${filename}" 'select(.InternalName != null) | . + {DownloadLinkInstall: $url}' "$manifest_path" > single_plugin.json
            
            # 寫入表格
            P_NAME=$(jq -r '.Name' single_plugin.json)
            P_VER=$(jq -r '.AssemblyVersion' single_plugin.json)
            P_DESC=$(jq -r '.Description' single_plugin.json | tr '\n' ' ' | sed 's/|/\\|/g')
            echo "| $P_NAME | $P_VER | $P_DESC |" >> "$OUT_DIR/index.md"

            jq --slurpfile new single_plugin.json '. + $new' "$OUT_DIR/repo.json" > "$OUT_DIR/new_repo.json"
            mv "$OUT_DIR/new_repo.json" "$OUT_DIR/repo.json"
            rm -rf "$TMP_WORK" single_plugin.json
          done
          
          # 【關鍵防護】在輸出的 plugins 資料夾放一個空白首頁，防止別人目錄瀏覽
          touch "$PLUGINS_OUT/index.html"
          touch "$OUT_DIR/.nojekyll"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          publish_branch: gh-pages
